name: Veracode Findings Diff (A/B/C/D) - GitHub Only

on:
  workflow_dispatch:
    inputs:
      application_name:
        description: "Veracode application profile name (exact match)"
        required: true
        default: "Juice-Shop-GitHub-Demo"

permissions:
  contents: read
  actions: read

jobs:
  findings_diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq + unzip
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download latest and previous reporting artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          REPORTING_WORKFLOW_FILE: veracode-reporting-pull-single-app.yml
        run: |
          set -euo pipefail

          mkdir -p cur_artifact prev_artifact out/diff
          BASELINE_ONLY=0

          RUNS_JSON="$(curl -sS \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${REPORTING_WORKFLOW_FILE}/runs?status=success&per_page=20")"

          RUN1="$(echo "$RUNS_JSON" | jq -r '.workflow_runs[0].id // empty')"
          RUN2="$(echo "$RUNS_JSON" | jq -r '.workflow_runs[1].id // empty')"

          if [ -z "${RUN1}" ]; then
            echo "No successful reporting runs found. Run veracode-reporting-pull-single-app.yml at least once."
            exit 1
          fi

          if [ -z "${RUN2}" ]; then
            echo "Only one successful reporting run found. Baseline-only mode."
            BASELINE_ONLY=1
          fi

          get_artifact_id () {
            local run_id="$1"
            local arts_json
            arts_json="$(curl -sS \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${OWNER}/${REPO}/actions/runs/${run_id}/artifacts")"

            echo "$arts_json" | jq -r '
              .artifacts
              | map(select(.name=="veracode-reporting-findings-single-app"))
              | .[0].id // empty
            '
          }

          ART1="$(get_artifact_id "${RUN1}")"
          if [ -z "${ART1}" ]; then
            echo "Artifact 'veracode-reporting-findings-single-app' not found on run ${RUN1}."
            exit 1
          fi

          echo "Downloading CURRENT artifact from run ${RUN1} (artifact ${ART1})"
          curl -L -sS \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/artifacts/${ART1}/zip" \
            -o cur_artifact/cur.zip
          unzip -o cur_artifact/cur.zip -d cur_artifact/unzipped >/dev/null

          if [ "${BASELINE_ONLY}" = "0" ]; then
            ART2="$(get_artifact_id "${RUN2}")"
            if [ -z "${ART2}" ]; then
              echo "Artifact 'veracode-reporting-findings-single-app' not found on run ${RUN2}. Switching to baseline-only."
              BASELINE_ONLY=1
            else
              echo "Downloading PREVIOUS artifact from run ${RUN2} (artifact ${ART2})"
              curl -L -sS \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${OWNER}/${REPO}/actions/artifacts/${ART2}/zip" \
                -o prev_artifact/prev.zip
              unzip -o prev_artifact/prev.zip -d prev_artifact/unzipped >/dev/null
            fi
          fi

          echo "BASELINE_ONLY=${BASELINE_ONLY}" >> $GITHUB_ENV

      - name: Find JSON files in artifacts and run diff
        env:
          APP_NAME: ${{ inputs.application_name }}
        run: |
          set -euo pipefail
          mkdir -p out/diff
          BASELINE_ONLY="${BASELINE_ONLY:-0}"

          CUR="$(find cur_artifact/unzipped -type f -name "findings_single_app_${APP_NAME}.json" | head -n 1 || true)"
          if [ -z "$CUR" ]; then
            echo "Current findings not found in latest artifact."
            echo "Debug: listing findings_single_app_*.json under cur_artifact/unzipped:"
            find cur_artifact/unzipped -maxdepth 6 -type f -name "findings_single_app_*.json" -print || true
            echo "Debug: listing first 50 json files under cur_artifact/unzipped:"
            find cur_artifact/unzipped -maxdepth 6 -type f -name "*.json" -print | head -n 50 || true
            exit 1
          fi
          echo "Using CUR=$CUR"

          if [ "${BASELINE_ONLY}" = "1" ]; then
            echo "# Veracode Findings Diff â€” ${APP_NAME}" > out/diff/README.md
            echo "" >> out/diff/README.md
            echo "Only one reporting snapshot exists in GitHub artifacts." >> out/diff/README.md
            echo "Run veracode-reporting-pull-single-app.yml again to enable A/B/C/D diffs." >> out/diff/README.md
            exit 0
          fi

          PREV="$(find prev_artifact/unzipped -type f -name "findings_single_app_${APP_NAME}.json" | head -n 1 || true)"
          if [ -z "$PREV" ]; then
            echo "Previous findings not found in previous artifact."
            echo "Debug: listing findings_single_app_*.json under prev_artifact/unzipped:"
            find prev_artifact/unzipped -maxdepth 6 -type f -name "findings_single_app_*.json" -print || true
            exit 1
          fi
          echo "Using PREV=$PREV"

          python scripts/diff_reporting_findings.py \
            --app-name "${APP_NAME}" \
            --current "$CUR" \
            --previous "$PREV" \
            --out-dir "out/diff"

      - name: Upload diff outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-findings-diff
          path: out/diff/
