name: Veracode Pipeline Scan (GitHub Code Scanning)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - master
      - main

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  pipeline_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create source zip (exclude node_modules)
        run: |
          zip -r pipeline-src.zip . \
            -x "**/node_modules/**" \
            -x "**/.git/**"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Download Veracode Pipeline Scan tool
        run: |
          curl -sSLO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip -o pipeline-scan-LATEST.zip

      - name: Run Veracode Pipeline Scan
        continue-on-error: true
        env:
          VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
          VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}
        run: |
          java -jar pipeline-scan.jar \
            --veracode_api_id "${VERACODE_API_ID}" \
            --veracode_api_key "${VERACODE_API_KEY}" \
            --file "pipeline-src.zip" \
            --json_output_file "results.json" \
            --filtered_json_output_file "filtered_results.json"

      - name: Summarize vulnerabilities (from results.json)
        run: |
          python - << 'PY'
          import json
          from collections import Counter

          SEVERITY_MAP = {
              "5": "VERY_HIGH",
              "4": "HIGH",
              "3": "MEDIUM",
              "2": "LOW",
              "1": "VERY_LOW",
              "0": "INFO"
          }

          try:
              with open("results.json", "r", encoding="utf-8") as f:
                  data = json.load(f)
          except Exception as e:
              print("Could not read results.json:", e)
              raise SystemExit(0)

          findings = data.get("findings") or data.get("issues") or data.get("results") or []
          if not isinstance(findings, list):
              print("No findings array detected.")
              raise SystemExit(0)

          c = Counter()
          for f in findings:
              raw = str(f.get("severity") or f.get("severity_level") or f.get("severityCode") or "UNKNOWN")
              sev = SEVERITY_MAP.get(raw, raw)
              c[sev] += 1

          print("\n=== Veracode Pipeline Scan Summary ===")
          for sev in ["VERY_HIGH","HIGH","MEDIUM","LOW","VERY_LOW","INFO","UNKNOWN"]:
              if c.get(sev):
                  print(f"{sev}: {c[sev]}")
          print(f"TOTAL ISSUES: {sum(c.values())}")
          print("====================================\n")
          PY

      - name: Convert Pipeline Scan results to SARIF
        run: |
          python scripts/pipeline_results_to_sarif.py results.json veracode-pipeline.sarif

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: veracode-pipeline.sarif
          category: veracode-pipeline

      - name: Upload Pipeline Scan JSON outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: veracode-pipeline-scan-results
          path: |
            results.json
            filtered_results.json
            veracode-pipeline.sarif
